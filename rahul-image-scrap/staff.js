const puppeteer = require('puppeteer');
const fs = require('fs');
const XLSX = require('xlsx');
const cheerio = require('cheerio');

async function fetchStaffs(url, page) {
    try {

        
      // const stateCodes = ['01','02','03','04','05',33,10,11,12,13,14,34,15,16,37,19,17,18,20,21,22,23,24,25,26,27,28,29,36,38,30,35,31,32]
    
          await page.goto(url, { waitUntil: 'networkidle0', ignoreHTTPSErrors: true });

          // await page.waitForTimeout(1000); // Adjust this time based on the website's behavior

          staffs = await page.evaluate(() => {  
            
            const allTrs = document.querySelector('.mprtbl').querySelectorAll('tr')
           
            const allTrsArray = Array.from(allTrs)
            
            const staffsForThisDistrictCode = []; 

            allTrsArray.forEach((tr,index) => {
               
                if(index > 0){
               
                  const tdValues = Array.from(tr.querySelectorAll('td')).map(eachTd => eachTd.innerText);

                  staffsForThisDistrictCode.push(tdValues)

                }
            })

            return staffsForThisDistrictCode;

          });



      return staffs;

    }catch (error) {
      console.error(`Error fetching HTML from ${url}: ${error.message}`);
      return [];
  }

}
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

async function processExcel() {

  const browser = await puppeteer.launch({
    headless: false,
    ignoreHTTPSErrors: true,
    args: ['--ignore-certificate-errors'],
  });

  const page = await browser.newPage();

      await page.setViewport({ width: 1366, height: 768 });


      const districtCodes = ["0102","0103","0101","0215","0216","0212","0224","0221","0210","0204","0219","0207","0217","0218","0206","0213","0226","0220","0222","0214","0208","0209","0201","0225","0223","0203","0202","0205","0211","0317","0310","0303","0307","0322","0320","0316","0323","0309","0318","0314","0324","0304","0319","0325","0312","0326","0321","0301","0311","0315","0313","0305","0302","0306","0434","0424","0405","0433","0403","0423","0432","0425","0408","0411","0401","0417","0420","0404","0414","0422","0431","0415","0407","0426","0419","0421","0402","0410","0429","0412","0413","0406","0416","0409","0428","0435","0418","0427","0430","0541","0551","0505","0545","0517","0527","0503","0548","0519","0507","0511","0550","0506","0549","0524","0525","0542","0546","0522","0520","0526","0515","0502","0508","0512","0501","0513","0523","0504","0521","0518","0509","0547","0543","0514","0510","0544","0516","3321","3319","3327","3311","3322","3317","3301","3312","3309","3303","3320","3328","3314","3307","3310","3302","3329","3323","3308","3306","3315","3331","3330","3324","3318","3313","3316","3304","3333","3332","3325","3326","3305","1001","1002","1112","1105","1122","1127","1108","1116","1104","1131","1133","1119","1128","1123","1111","1132","1101","1106","1107","1113","1110","1129","1130","1124","1125","1114","1120","1121","1102","1109","1117","1103","1126","1115","1118","1201","1213","1222","1209","1218","1210","1215","1220","1214","1204","1205","1203","1212","1219","1221","1217","1206","1211","1208","1216","1207","1202","1301","1302","1303","1304","1305","1306","1307","1308","1309","1310","1311","1312","1406","1419","1402","1404","1409","1420","1413","1414","1415","1421","1401","1411","1405","1412","1416","1417","1418","1422","1403","1410","3420","3417","3422","3421","3411","3410","3407","3419","3415","3403","3416","3412","3424","3418","3406","3402","3414","3405","3423","3401","3413","3409","3404","3408","1501","1505","1504","1502","1503","1506","1508","1528","1509","1510","1511","1512","1513","1514","1516","1517","1515","1518","1519","1520","1521","1522","1523","1529","1524","1525","1526","1527","1531","1507","1530","1611","1608","1609","1602","1601","1613","1610","1604","1605","1606","1612","1614","1607","1603","3702","3701","1901","1751","1749","1746","1748","1738","1742","1731","1702","1728","1747","1708","1736","1711","1704","1720","1722","1745","1706","1703","1743","1723","1733","1721","1744","1725","1724","1735","1716","1701","1732","1734","1741","1752","1709","1730","1726","1717","1713","1710","1712","1729","1737","1714","1719","1739","1705","1715","1750","1707","1718","1740","1727","1809","1823","1824","1818","1828","1822","1829","1815","1820","1807","1830","1833","1834","1808","1816","1814","1821","1836","1801","1827","1819","1831","1806","1835","1817","1810","1803","1804","1812","1811","1805","1813","1802","1826","1832","1825","2006","2004","2003","2009","2007","2010","2012","2014","2011","2016","2015","2001","2002","2013","2005","2008","2112","2104","2101","2102","2110","2107","2106","2111","2109","2105","2108","2103","2201","2206","2209","2210","2205","2208","2202","2204","2203","2211","2207","2308","2309","2301","2310","2305","2307","2311","2302","2306","2304","2303","2421","2405","2414","2417","2409","2426","2406","2416","2407","2424","2412","2419","2420","2415","2410","2408","2418","2403","2423","2411","2431","2404","2430","2422","2428","2413","2429","2401","2427","2402","2502","2501","2602","2621","2611","2612","2618","2622","2603","2601","2607","2605","2606","2604","2624","2617","2615","2616","2623","2609","2608","2610","2619","2614","2620","2721","2706","2728","2731","2717","2707","2724","2703","2723","2729","2704","2711","2708","2727","2702","2712","2716","2718","2732","2705","2715","2709","2730","2714","2720","2733","2725","2710","2713","2719","2701","2722","2726","2802","2804","2801","2803","2806","2805","2931","2937","2939","2911","2903","2909","2922","2910","2938","2901","2928","2917","2930","2920","2936","2914","2908","2918","2919","2923","2935","2907","2925","2934","2913","2921","2912","2932","2927","2916","2926","2933","2902","2906","2915","2905","2904","2924","3601","3602","3630","3603","3604","3605","3606","3607","3608","3609","3610","3611","3612","3613","3614","3615","3616","3632","3617","3618","3633","3619","3620","3621","3622","3623","3624","3625","3626","3627","3628","3629","3631","3801","3802","3803","3004","3008","3006","3003","3007","3002","3005","3001","3507","3512","3504","3510","3502","3503","3508","3505","3511","3506","3513","3509","3501","3120","3118","3178","3181","3167","3169","3149","3157","3165","3146","3159","3175","3142","3148","3125","3153","3109","3124","3117","3171","3177","3155","3122","3135","3134","3143","3121","3164","3116","3160","3147","3154","3141","3182","3130","3166","3138","3158","3139","3168","3136","3137","3180","3170","3128","3172","3140","3132","3152","3179","3123","3119","3156","3115","3162","3110","3114","3126","3144","3145","3133","3111","3112","3183","3174","3173","3127","3184","3176","3151","3129","3163","3150","3131","3161","3215","3216","3220","3213","3203","3208","3219","3217","3218","3206","3205","3207","3223","3224","3221","3209","3212","3201","3222","3210","3202","3211","3214","3204"]

      let allStaffs = [];

        for (const [index, districtCode] of districtCodes.entries()) {
          const url = `http://www.nrlm.gov.in/mmuMasterReport.do?methodName=getBlockTypeCoreStaffDetail&blockType=all&districtCode=${districtCode}`

            const staffs = await fetchStaffs(url, page)  
            allStaffs = [...allStaffs, ...staffs]
            console.log(index, ': ', allStaffs.length )


        }



  console.log('total stafffs: ',allStaffs.length)

  // Extract keys from the object with the greatest number of keys
  const fields = ["S.NO", "Block Name", "Member Name", "Education", "Experience", "Mobile", "Email", "Status"]
  
  allStaffs.unshift(fields);

  fs.writeFileSync('op-all-staffs.json', JSON.stringify(allStaffs), 'utf8');

  console.log('json file has been saved');  
    // Convert JSON to CSV
  const csvString = allStaffs.map(row => row.join(',')).join('\n');

  fs.writeFileSync('op-all-staffs.csv', csvString, 'utf8');

  console.log('CSV file has been saved');

}

processExcel()
